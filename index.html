<script>
function parseCSV(text) {
  const rows = [];
  let cur = "", inQ = false, row = [];
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const next = text[i + 1];
    if (ch === '"' && inQ && next === '"') { cur += '"'; i++; continue; }
    if (ch === '"') { inQ = !inQ; continue; }
    if (ch === ',' && !inQ) { row.push(cur.trim()); cur = ""; continue; }
    if ((ch === '\n' || ch === '\r') && !inQ) {
      if (cur.length || row.length) { row.push(cur.trim()); rows.push(row); }
      cur = ""; row = [];
      if (ch === '\r' && next === '\n') i++;
      continue;
    }
    cur += ch;
  }
  if (cur.length || row.length) { row.push(cur.trim()); rows.push(row); }
  return rows;
}

function toObj(headers, row) {
  const o = {};
  headers.forEach((h, i) => o[h] = (row[i] ?? "").trim());
  return o;
}

const teamASel = document.getElementById('teamASel');
const teamBSel = document.getElementById('teamBSel');
const outMeta = document.getElementById('outMeta');
const outPick = document.getElementById('outPick');
const outUnits = document.getElementById('outUnits');
const topPlaysMeta = document.getElementById('topPlaysMeta');
const topPlaysList = document.getElementById('topPlaysList');
const summaryContent = document.getElementById('summaryContent');
const kpis = document.getElementById('kpis');

let data = [];

function uniq(arr) {
  return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b));
}

function findGame(a, b) {
  return data.find(d => 
    (d.TeamA === a && d.TeamB === b) ||
    (d.TeamA === b && d.TeamB === a)
  ) || null;
}

function render(game, a, b) {
  if (!a || !b) {
    outMeta.innerHTML = "";
    outPick.textContent = "Select both teams";
    outUnits.textContent = "";
    return;
  }

  if (!game) {
    outMeta.innerHTML = "";
    outPick.textContent = "Matchup not found";
    outUnits.textContent = "";
    return;
  }

  const bet = (game.Bet || "").toUpperCase() === "BET";

  outMeta.innerHTML =
    `<span class="pill ${bet ? "bet" : "nobet"}">${bet ? "BET" : "NO BET"}</span>`;

  outPick.textContent = game.Pick || "—";
  outUnits.textContent = "";
}

function setTeamBOptions(selectedA) {
  if (!selectedA) {
    teamBSel.innerHTML = `<option value="">—</option>`;
    return;
  }

  const opponents = uniq(
    data.flatMap(d => {
      if (d.TeamA === selectedA) return [d.TeamB];
      if (d.TeamB === selectedA) return [d.TeamA];
      return [];
    })
  );

  teamBSel.innerHTML =
    `<option value="">—</option>` +
    opponents.map(t => `<option value="${t}">${t}</option>`).join("");
}

async function init() {
  const resp = await fetch(`picks.csv?cb=${Date.now()}`);
  if (!resp.ok) throw new Error("Could not load picks.csv");

  const text = await resp.text();
  const rows = parseCSV(text).filter(r => r.length && r.some(x => String(x).trim() !== ""));
  const headers = rows.shift().map(h => h.replace(/\uFEFF/g,'').trim());
  data = rows.map(r => toObj(headers, r));

  const totalGames = data.length;
  const totalBets = data.filter(d => (d.Bet || "").toUpperCase() === "BET").length;

  summaryContent.innerHTML = `Games loaded: <b>${totalGames}</b>`;

  kpis.innerHTML = `
    <span class="pill"><b>Bets</b>: ${totalBets}</span>
  `;

  const teams = uniq(data.flatMap(d => [d.TeamA, d.TeamB]));

  teamASel.innerHTML =
    `<option value="">—</option>` +
    teams.map(t => `<option value="${t}">${t}</option>`).join("");

  teamASel.addEventListener('change', () => {
    const a = teamASel.value;
    setTeamBOptions(a);
    teamBSel.value = "";
    render(null, "", "");
  });

  teamBSel.addEventListener('change', () => {
    const a = teamASel.value;
    const b = teamBSel.value;
    render(findGame(a, b), a, b);
  });

  setTeamBOptions("");
  render(null, "", "");
}

init().catch(err => {
  outPick.textContent = "Error loading picks.csv";
  outPick.className = "error big";
  outUnits.textContent = err.message;
});
</script>
